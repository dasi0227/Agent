# MCPï¼šä¼ä¸šå¾®ä¿¡å‘é€åº”ç”¨æ¶ˆæ¯



## åŠ¨æœº

xfg æ•™ç¨‹é‡Œé¢æ˜¯ä½¿ç”¨å…¬ä¼—å·è¿›è¡Œæ¶ˆæ¯å‘å¸ƒï¼Œæˆ‘ä¸æƒ³ä½¿ç”¨æµ‹è¯•å·ï¼Œäºæ˜¯å°±æ‰“ç®—è‡ªå·±æ³¨å†Œä¸€ä¸ªå…¬ä¼—å·ï¼Œçœ‹çœ‹èƒ½å¦æŠ•å…¥åˆ°å®é™…ç”Ÿäº§ä½¿ç”¨ä¹‹ä¸­

ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯åœ¨å¾®ä¿¡**å…¬ä¼—å·å®é™…åˆ†ä¸ºã€è®¢é˜…å·ã€‘å’Œã€æœåŠ¡å·ã€‘**ï¼Œåªæœ‰æœåŠ¡å·å¯ä»¥åˆ›å»ºæ¨¡ç‰ˆæ¶ˆæ¯ï¼Œä½†æ˜¯æœåŠ¡å·åˆéœ€è¦è¿›è¡Œä»€ä¹ˆä¼ä¸šè®¤è¯ï¼Œè€Œä¸”**éœ€è¦èŠ±é’±**ï¼Œæ˜¾ç„¶ä¸é€‚åˆä¸ªäººå¼€å‘è€…å­¦ä¹ ï¼Œäºæ˜¯ä¹å°±æ³¨å†Œäº†ä¸€ä¸ªè®¢é˜…å·ğŸ˜ 

<img src="https://dasi-blog.oss-cn-guangzhou.aliyuncs.com/Casual/202601100029645.png" style="zoom:25%;" />

ç¬¬äºŒä¸ªé—®é¢˜æ¥è¸µè€Œè‡³ï¼Œé¦–å…ˆä¸å¾—ä¸åæ§½å¾®ä¿¡æ–°åˆ›å»ºçš„å¾®ä¿¡å¼€å‘æ–‡æ¡£ï¼Œæƒ³æ‰¾ä¸ªæ¥å£ä½¿ç”¨è¯´æ˜æ˜¯çœŸéº»çƒ¦ï¼Œ**æœç´¢â€œå‘å¸ƒæ–‡ç« â€å±…ç„¶æ‰¾ä¸åˆ°ä½ æ•¢ä¿¡**ï¼Ÿä»–å±…ç„¶ä¹Ÿä¸è¯´ä¸€å£°å¿…é¡»å…ˆä¿å­˜è‰ç¨¿å†å‘å¸ƒè‰ç¨¿æ‰èƒ½å®ç°å‘å¸ƒæ–‡ç« ã€‚è¿™å°±ç®—äº†ï¼Œå¥½ä¸å®¹æ˜“å¼€å§‹å¼€å‘æ¥å£ï¼Œæåˆ°ä¸€åŠçªç„¶å‘ç°ä¸€è¡Œå°å­—ï¼Œä¸ªäººä¸»ä½“è´¦å·å±…ç„¶ä¸å…è®¸è°ƒç”¨è¿™äº›æ¥å£ï¼Œç½‘ä¸Šä¸€æœæ‰çŸ¥é“è·Ÿå›½å®¶æ–°å‡ºå°çš„æ”¿ç­–**ã€Šå›½å®¶ç½‘ç»œèº«ä»½è®¤è¯å…¬å…±æœåŠ¡ç®¡ç†åŠæ³•ã€‹**æœ‰å…³ï¼Œé‚£æ²¡åŠæ³•äº†ğŸ‘

<img src="https://dasi-blog.oss-cn-guangzhou.aliyuncs.com/Casual/202601100029644.png" style="zoom: 25%;" />

æ‰€ä»¥è¿™æ¡è·¯å­è¢«å µæ­»äº†ï¼Œçªç„¶æƒ³èµ·æ¥æˆ‘ä»¥å‰åšè¿‡ä¸€ä¸ªæ¶ˆæ¯ä¸­å°çš„é¡¹ç›®ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªåœ¨ä¼ä¸šå¾®ä¿¡çš„å†…éƒ¨åº”ç”¨ä¸­å‘é€æ¶ˆæ¯çš„åŠŸèƒ½ï¼Œæ˜¾ç„¶å¾ˆé€‚åˆè¿™é‡Œçš„ API è°ƒç”¨ï¼Œè€Œä¸”æœ¬è´¨ä¸Šå’Œå…¬ä¼—å·æ˜¯å¾ˆåƒçš„ï¼Œå¹¶ä¸”æ”¯æŒå„ç§å„æ ·çš„æ¶ˆæ¯ç±»å‹ï¼ˆæ–‡æœ¬ã€å¡ç‰‡ã€å›¾æ–‡ã€è§†é¢‘ï¼‰ï¼Œæ‰€ä»¥æ‰è½¬å‘ä½¿ç”¨ä¼ä¸šå¾®ä¿¡æ¥å¼€å‘ã€‚



##ä¼ä¸šå¾®ä¿¡é…ç½®è¿‡ç¨‹

1. æ³¨å†Œä¼ä¸šå¾®ä¿¡ï¼Œæ ¹æ®[å®˜æ–¹æ•™æ](https://open.work.weixin.qq.com/help2/pc/15422)æ¥æå°±å¥½ï¼Œå…¶å®ä¸æ˜¯å¾ˆéº»çƒ¦ï¼Œæˆ‘ä¹‹å‰å¤§æ¦‚æäº†1å°æ—¶å§ğŸ˜“

2. è·å–ä¼ä¸šid

    <img src="https://dasi-blog.oss-cn-guangzhou.aliyuncs.com/Casual/202601100029649.png" style="zoom: 20%;" />

3. åˆ›å»ºè‡ªå»ºåº”ç”¨

    <img src="https://dasi-blog.oss-cn-guangzhou.aliyuncs.com/Casual/202601100029646.png" style="zoom:20%;" />

4. è·å–åº”ç”¨idå’Œåº”ç”¨secret

    <img src="https://dasi-blog.oss-cn-guangzhou.aliyuncs.com/Casual/202601100029648.png" style="zoom:50%;" />

5. é…ç½®å¯ä¿¡IPï¼šè¿™ä¸€æ­¥ä½ å¯ä»¥å…ˆä¸é…ç½®ï¼Œç„¶åè°ƒç”¨ä¸€æ¬¡ï¼Œåœ¨ä¼ä¸šå¾®ä¿¡çš„å“åº”ä¸­ä½ å°±å¯ä»¥è·å–åˆ°å½“å‰ä½ ç”µè„‘çš„å…¬ç½‘IPäº†ï¼Œç»å¯¹æ­£ç¡®ğŸ¶

    <img src="https://dasi-blog.oss-cn-guangzhou.aliyuncs.com/Casual/202601100029650.png" style="zoom:20%;" />

> æ³¨æ„å¼€å’Œå…³ ğŸªœ çš„å…¬ç½‘ IP ä¸ä¸€æ ·ï¼Œç”¨ä¸åŒ WiFi çš„å…¬ç½‘ IP ä¹Ÿä¸ä¸€æ ·ï¼Œå½“ç„¶ä½ ç§Ÿäº†æœåŠ¡å™¨ç›´æ¥ç”¨å›ºå®šçš„å…¬ç½‘ IP ä¹Ÿå¯ä»¥



## ä¼ä¸šå¾®ä¿¡è°ƒç”¨æ¥å£è¿‡ç¨‹

1. æ‰€æœ‰ä¼ä¸šå¾®ä¿¡çš„æ¥å£è°ƒç”¨çš„ç¬¬ä¸€æ­¥éƒ½æ˜¯[è·å– access_token](https://developer.work.weixin.qq.com/document/path/91039)ï¼Œæ¥å£ç®€è¿°å¦‚ä¸‹

    ```
    è¯·æ±‚ï¼š GETï¼ˆHTTPSï¼‰https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=ID&corpsecret=SECRET
    è¯·æ±‚ä½“ï¼šæ— 
    å“åº”ä½“ï¼š
    {
        "errcode": 0,
        "errmsg": "ok",
        "access_token": "accesstoken000001",
        "expires_in": 7200
    }
    ```

2. ç„¶åå°±æ˜¯è°ƒç”¨[å‘é€åº”ç”¨æ¶ˆæ¯æ¥å£](https://developer.work.weixin.qq.com/document/path/90236)ï¼Œè¿™é‡Œä»¥æ–‡æœ¬å¡ç‰‡ä¸ºä¾‹å­ï¼Œæ¥å£ç®€è¿°å¦‚ä¸‹ï¼Œè¿™é‡Œå»ºè®®**ç›´æ¥ç”¨ touser="@all" è¡¨ç¤ºå‘é€åˆ°æ‰€æœ‰äºº**ï¼Œå°±ä¸ç”¨è´¹åŠ²è®¾ç½®æ ‡ç­¾å’Œç¾¤ç»„äº†ï¼Œè¿˜æœ‰å°±æ˜¯**æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥å“åº”çš„å­—æ®µåéƒ½æ˜¯ errcode å’Œ errmsg**ï¼Œä¸è¦ä»¥ä¸ºæ˜¯è‡ªå·±çš„é—®é¢˜ğŸ˜

    ```
    è¯·æ±‚ï¼šPOSTï¼ˆHTTPSï¼‰https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=ACCESS_TOKEN
    è¯·æ±‚ä½“ï¼š
    {
        "touser" : "UserID1|UserID2|UserID3",
        "toparty" : "PartyID1 | PartyID2",
        "totag" : "TagID1 | TagID2",
        "msgtype" : "textcard",
        "agentid" : 1,
        "textcard" : {
            "title" : "æ´¾å…‹ç‰¹å—¦åŠ",
            "description" : "é˜¿é‡Œå˜å¤šæ‘†é”¤å­",
            "url" : "https://example.com",
            "btntxt" : "æ›´å¤š"
        },
        "enable_id_trans": 0,
        "enable_duplicate_check": 0,
        "duplicate_check_interval": 1800
    }
    å“åº”ä½“ï¼š
    {
      "errcode" : 0,
      "errmsg" : "ok",
      "invaliduser" : "userid1|userid2",
      "invalidparty" : "partyid1|partyid2",
      "invalidtag": "tagid1|tagid2",
      "unlicenseduser" : "userid3|userid4",
      "msgid": "xxxx",
      "response_code": "xyzxyz"
    }
    ```

> å¯ä»¥å…ˆåˆ°[å®˜æ–¹åœ¨çº¿æµ‹è¯•å·¥å…·](https://developer.work.weixin.qq.com/resource/devtool)æµ‹è¯•æ¥å£ä½¿ç”¨æ–¹å¼ï¼Œä¼šæ›´æ·±åˆ»ç†è§£ä¸€ç‚¹



## MCP å®ç°

è¿™é‡Œåªè´´å‡ºå…³é”®ç±»ï¼Œä»£ç ç»“æ„å’Œå‘½åæ–¹å¼å’Œ xfg åŸºæœ¬ä¿æŒä¸€è‡´ï¼Œ**å»ºè®®åœ¨ csdn çš„åŸºç¡€ä¸Šæ›´æ”¹å³å¯ï¼ˆä¸è¦åœ¨ weixin çš„åŸºç¡€ä¸Šï¼‰**

`NoticeWeComPort`

```java
@Slf4j
@Service
public class NoticeWeComPort implements INoticeWeiXinPort {

    @Resource
    private NoticeWeComProperties noticeWeComProperties;

    @Resource
    private INoticeWeComHttp noticeWeComHttp;

    private String getAccessToken() throws IOException {

        Call<AccessTokenWeComResponse> call = noticeWeComHttp.getAccessToken(
                noticeWeComProperties.getCorpid(),
                noticeWeComProperties.getCorpsecret()
        );

        Response<AccessTokenWeComResponse> callResponse = call.execute();

        if (!callResponse.isSuccessful()) {
            String err = callResponse.errorBody() == null ? "<empty>" : callResponse.errorBody().string();
            log.error("WeCom è·å– access_token å¤±è´¥: {}", err);
            return null;
        }

        AccessTokenWeComResponse tokenResponse = callResponse.body();

        if (tokenResponse == null) {
            log.error("WeCom è·å– access_token çš„å“åº”ä½“ä¸ºç©º");
            return null;
        }

        if (tokenResponse.getErrcode() != null && tokenResponse.getErrcode() != 0) {
            log.error("WeCom è·å– access_token å¤±è´¥: {}", tokenResponse.getErrmsg());
            return null;
        }

        String accessToken = tokenResponse.getAccess_token();
        if (accessToken == null || accessToken.isBlank()) {
            log.error("WeCom è·å– access_token çš„å†…å®¹ä¸ºç©º");
            return null;
        }

        log.info("è°ƒç”¨ HTTP è·å–ä¼ä¸šå¾®ä¿¡ä»¤ç‰Œï¼štoken={}", accessToken);

        return accessToken;
    }

    @Override
    public NoticeWeComToolResponse noticeArticle(NoticeWeComToolRequest toolRequest) throws IOException {

        NoticeWeComHttpRequest.MsgData msgData = new NoticeWeComHttpRequest.MsgData();
        msgData.setTitle(toolRequest.getTitle());
        msgData.setDescription(toolRequest.getDescription());
        msgData.setUrl(toolRequest.getUrl());

        NoticeWeComHttpRequest httpRequest = new NoticeWeComHttpRequest();
        httpRequest.setAgentid(noticeWeComProperties.getAgentid());
        httpRequest.setTextcard(msgData);

        String accessToken = getAccessToken();

        NoticeWeComToolResponse toolResponse = new NoticeWeComToolResponse();

        if (accessToken == null || accessToken.isBlank()) {
            toolResponse.setCode(500);
            toolResponse.setInfo("WeCom access_token è·å–å¤±è´¥");
            return toolResponse;
        }

        Call<NoticeWeComHttpResponse> call = noticeWeComHttp.noticeArticle(httpRequest, accessToken);
        Response<NoticeWeComHttpResponse> callResponse = call.execute();
        log.info("è°ƒç”¨ HTTP è¿›è¡Œä¼ä¸šå¾®ä¿¡åº”ç”¨æ¶ˆæ¯é€šçŸ¥ï¼šæ ‡é¢˜={} æ¦‚è¿°={} é“¾æ¥={}", toolRequest.getTitle(), toolRequest.getDescription(), toolRequest.getUrl());

        if (!callResponse.isSuccessful()) {
            String err = callResponse.errorBody() == null ? "<empty>" : callResponse.errorBody().string();
            toolResponse.setCode(callResponse.code());
            toolResponse.setInfo("WeCom HTTP è¯·æ±‚å¤±è´¥: " + err);
            return toolResponse;
        }

        NoticeWeComHttpResponse httpResponse = callResponse.body();

        if (httpResponse == null) {
            toolResponse.setCode(500);
            toolResponse.setInfo("WeCom HTTP å“åº”ä½“ä¸ºç©º");
            return toolResponse;
        }

        toolResponse.setCode(httpResponse.getErrcode());
        toolResponse.setInfo(httpResponse.getErrmsg());
        toolResponse.setMsgid(httpResponse.getMsgid());

        return toolResponse;
    }

}
```

`NoticeWeComHttp`

```java
public interface INoticeWeComHttp {
    @GET("/cgi-bin/gettoken")
    Call<AccessTokenWeComResponse> getAccessToken(
            @Query("corpid") String corpId,
            @Query("corpsecret") String corpSecret);

    @POST("/cgi-bin/message/send")
    Call<NoticeWeComHttpResponse> noticeArticle(
            @Body NoticeWeComHttpRequest request,
            @Query("access_token") String accessToken);

}
```

`NoticeWeComToolRequest` å’Œ `NoticeWeComToolResponse`

```java
@Data
@JsonInclude(JsonInclude.Include.NON_NULL)
public class NoticeWeComToolRequest {

    @JsonProperty(required = true, value = "title")
    @JsonPropertyDescription("ä¸»é¢˜")
    private String title;

    @JsonProperty(required = true, value = "description")
    @JsonPropertyDescription("æè¿°")
    private String description;

    @JsonProperty(required = true, value = "url")
    @JsonPropertyDescription("è·³è½¬åœ°å€")
    private String url;

}

@Data
@JsonInclude(JsonInclude.Include.NON_NULL)
public class NoticeWeComToolResponse {

    @JsonProperty(required = true, value = "code")
    @JsonPropertyDescription("ä¼ä¸šå¾®ä¿¡è°ƒç”¨çŠ¶æ€ç ")
    private Integer code;

    @JsonProperty(required = true, value = "info")
    @JsonPropertyDescription("ä¼ä¸šå¾®ä¿¡è°ƒç”¨çŠ¶æ€ä¿¡æ¯")
    private String info;

    @JsonProperty(required = true, value = "msgid")
    @JsonPropertyDescription("ä¼ä¸šå¾®ä¿¡å‘é€çš„æ¶ˆæ¯ id")
    private String msgid;

}
```



## ç»“æœå±•ç¤º

<img src="https://dasi-blog.oss-cn-guangzhou.aliyuncs.com/Casual/202601100029643.jpg" style="zoom: 25%;" />

<img src="https://dasi-blog.oss-cn-guangzhou.aliyuncs.com/Casual/202601100029642.jpg" style="zoom: 25%;" />