<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SSE Viewer</title>
    <style>
        body{margin:0;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#0b0f17;color:#e6edf3}
        header{position:sticky;top:0;background:#0b0f17;border-bottom:1px solid #243042;padding:12px 14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        input,button,select{background:#111827;color:#e6edf3;border:1px solid #243042;border-radius:8px;padding:8px 10px}
        input{min-width:320px;flex:1}
        button{cursor:pointer}
        button:disabled{opacity:.5;cursor:not-allowed}
        .toggle{display:flex;gap:8px}
        .toggle button{min-width:72px}
        .toggle button.active{border-color:#34d399;color:#34d399;box-shadow:0 0 0 1px rgba(52,211,153,.35)}
        main{padding:12px 14px}
        .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .label{min-width:96px;color:#a8b3cf;font-size:12px}
        #log{white-space:pre-wrap;word-break:break-word;line-height:1.35}
        .card{border:1px solid #243042;border-radius:12px;padding:10px 12px;margin:10px 0;background:#0f1624}
        .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;font-size:12px;color:#a8b3cf;margin-bottom:6px}
        .meta .tag{border:1px solid #243042;border-radius:8px;padding:2px 8px}
        .meta .tag strong{color:#e6edf3}
        .json{margin:0;white-space:pre-wrap;word-break:break-word}
        .warn{color:#fbbf24}
        .err{color:#fb7185}
        .ok{color:#34d399}
    </style>
</head>
<body>
<header>
    <div class="row" style="width:100%">
        <span class="label">URL</span>
        <input id="url" value="http://localhost:8001/api/v1/agent/execute" />
    </div>
    <div class="row" style="width:100%">
        <span class="label">AgentId</span>
        <input id="aiAgentId" value="agent_" placeholder="aiAgentId" />
    </div>
    <div class="row" style="width:100%">
        <span class="label">SessionId</span>
        <input id="sessionId" value="-s-1" placeholder="sessionId" />
    </div>
    <div class="row" style="width:100%">
        <span class="label">ExecuteType</span>
        <div class="toggle" id="executeType">
            <button type="button" class="mode-btn active" data-value="loop">loop</button>
            <button type="button" class="mode-btn" data-value="step">step</button>
        </div>
    </div>
    <div class="row" style="width:100%">
        <span class="label">MaxRound</span>
        <input id="maxRound" type="number" value="2" placeholder="maxRound" />
    </div>
    <div class="row" style="width:100%">
        <span class="label">MaxRetry</span>
        <input id="maxRetry" type="number" value="2" placeholder="maxRetry" />
    </div>
    <div class="row" style="width:100%">
        <span class="label">UserMessage</span>
        <input id="userMessage" value="请总结今日AI新闻，今天是 2025.01.20" placeholder="userMessage" />
    </div>
    <div class="row" style="width:100%">
        <span class="label">Examples</span>
        <div class="toggle">
            <button class="preset mode-btn" data-message="请在索引 test_log_2026.01.20 中找出所有 ERROR，按 @timestamp 排序；按 errorType 分组统计数量，并给出每类错误的处理建议。">elk</button>
            <button class="preset mode-btn active" data-message="请总结今日AI新闻，今天是 2025.01.20">web</button>
            <button class="preset mode-btn" data-message="请你从 Grafana 通过 uid=sbapmwalker 拉取完整仪表盘信息，分析最近 15 分钟订单服务的整体健康情况，给出最可能的瓶颈点与下一步排查方向">grafana</button>
            <button class="preset mode-btn" data-message="我需要你发布一篇关于 Java 和 Spring 的趣味小故事到 CSDN 上，要求文风具有贴吧老哥的味道，同时将返回的 url 和故事标题、概述同步发送到企业微信的应用消息，最后将前两步的返回数据保存到 Users/wyw/Downloads/ 下的 test.txt，你可以调用 MCP 工具实现，这是 userMessage">article</button>
        </div>
    </div>
    <div class="row" style="width:100%">
        <button id="connect">Connect</button>
        <button id="disconnect" disabled>Disconnect</button>
        <button id="clear">Clear</button>
    </div>
</header>

<main>
    <div id="log"></div>
</main>

<script>
    (function () {
        const elUrl = document.getElementById('url');
        const elAiAgentId = document.getElementById('aiAgentId');
        const elSessionId = document.getElementById('sessionId');
        const elExecuteType = document.getElementById('executeType');
        const elMaxRound = document.getElementById('maxRound');
        const elMaxRetry = document.getElementById('maxRetry');
        const elUserMessage = document.getElementById('userMessage');
        const elConnect = document.getElementById('connect');
        const elDisconnect = document.getElementById('disconnect');
        const elClear = document.getElementById('clear');
        const elLog = document.getElementById('log');

        let es = null;
        let aborter = null;
        function clearLog() {
            elLog.innerHTML = '';
        }

        function scrollToBottom() {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function safeJsonParse(s) {
            try { return JSON.parse(s); } catch { return null; }
        }

        function formatText(text) {
            if (text == null) return '';
            if (typeof text !== 'string') {
                return JSON.stringify(text, null, 2);
            }
            const trimmed = text.trim();
            if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
                try { return JSON.stringify(JSON.parse(trimmed), null, 2); } catch (e) { /* ignore */ }
            }
            return text
                .replace(/\\n/g, '\n')
                .replace(/\\t/g, '\t')
                .replace(/\\r/g, '\r')
                .replace(/\\"/g, '"');
        }

        function pickExceptionField(obj) {
            if (!obj || typeof obj !== 'object') return null;
            for (const key of Object.keys(obj)) {
                if (key.endsWith('_exception')) {
                    return { key, value: obj[key] };
                }
            }
            return null;
        }

        function extractContent(data, raw) {
            if (data && data.sectionContent != null && data.sectionContent !== '') {
                const maybeJson = safeJsonParse(data.sectionContent);
                if (maybeJson) {
                    const ex = pickExceptionField(maybeJson);
                    if (ex) return { content: ex.value, sectionType: ex.key };
                }
                return { content: data.sectionContent, sectionType: data.sectionType };
            }
            const ex = pickExceptionField(data);
            if (ex) return { content: ex.value, sectionType: ex.key };
            return { content: raw || '', sectionType: data ? data.sectionType : undefined };
        }

        function renderEvent(evtName, data, raw) {
            const card = document.createElement('div');
            card.className = 'card';

            const meta = document.createElement('div');
            meta.className = 'meta';

            const t3 = document.createElement('span');
            t3.className = 'tag';
            const ct = data && data.clientType ? data.clientType : '-';
            t3.innerHTML = 'clientType: <strong>' + ct + '</strong>';

            const t4 = document.createElement('span');
            t4.className = 'tag';
            const extracted = extractContent(data, raw);
            const st = (data && data.sectionType) ? data.sectionType : (extracted.sectionType || '-');
            t4.innerHTML = 'sectionType: <strong>' + st + '</strong>';

            const t5 = document.createElement('span');
            t5.className = 'tag';
            const round = data && data.round != null
                ? data.round
                : (data && data.step != null ? data.step : '-');
            t5.innerHTML = 'round: <strong>' + round + '</strong>';

            meta.appendChild(t3);
            meta.appendChild(t4);
            meta.appendChild(t5);

            const pre = document.createElement('pre');
            pre.className = 'json';
            pre.textContent = formatText(extracted.content);

            card.appendChild(meta);
            card.appendChild(pre);
            elLog.appendChild(card);
            scrollToBottom();
        }

        function disconnect() {
            if (es) {
                es.close();
                es = null;
            }
            if (aborter) {
                aborter.abort();
                aborter = null;
            }
            elConnect.disabled = false;
            elDisconnect.disabled = true;
        }

        async function connectFetchPost() {
            disconnect();
            clearLog();
            elConnect.disabled = true;
            elDisconnect.disabled = false;

            const url = elUrl.value.trim();
            const maxRound = parseInt(elMaxRound.value.trim(), 10);
            const maxRetry = parseInt(elMaxRetry.value.trim(), 10);
            if (Number.isNaN(maxRound) || Number.isNaN(maxRetry)) {
                elConnect.disabled = false;
                elDisconnect.disabled = true;
                return;
            }

            const activeType = elExecuteType.querySelector('.mode-btn.active');
            const executeType = activeType ? activeType.dataset.value : 'loop';

            const payloadObj = {
                executeType: executeType,
                aiAgentId: elAiAgentId.value.trim(),
                userMessage: elUserMessage.value.trim(),
                sessionId: elSessionId.value.trim(),
                maxRound: maxRound,
                maxRetry: maxRetry
            };

            aborter = new AbortController();
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payloadObj),
                signal: aborter.signal
            });

            if (!res.ok) {
                elConnect.disabled = false;
                elDisconnect.disabled = true;
                return;
            }

            const reader = res.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let buffer = '';

            function parseSseChunk(text) {
                buffer += text;
                const parts = buffer.split('\n\n');
                buffer = parts.pop();

                for (const part of parts) {
                    const lines = part.split('\n');
                    let eventName = 'message';
                    let dataLines = [];
                    let id = '';

                    for (const line of lines) {
                        if (line.startsWith('event:')) eventName = line.slice(6).trim() || 'message';
                        else if (line.startsWith('id:')) id = line.slice(3).trim();
                        else if (line.startsWith('data:')) dataLines.push(line.slice(5).trimStart());
                    }

                    const raw = dataLines.join('\n');
                    const data = safeJsonParse(raw);
                    renderEvent(eventName, data, raw);

                }
            }

            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    parseSseChunk(decoder.decode(value, { stream: true }));
                }
            } catch (e) {
                if (aborter && aborter.signal.aborted) return;
            } finally {
                elConnect.disabled = false;
                elDisconnect.disabled = true;
            }
        }

        elConnect.addEventListener('click', () => connectFetchPost());
        elExecuteType.querySelectorAll('.mode-btn').forEach((btn) => {
            btn.addEventListener('click', () => {
                elExecuteType.querySelectorAll('.mode-btn').forEach((b) => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
        document.querySelectorAll('.preset').forEach((btn) => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.preset').forEach((b) => b.classList.remove('active'));
                btn.classList.add('active');
                elUserMessage.value = btn.dataset.message || '';
            });
        });

        elDisconnect.addEventListener('click', () => disconnect());
        elClear.addEventListener('click', () => clearLog());

        // 快捷键
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') disconnect();
        });

    })();
</script>
</body>
</html>
